# 第一题

## 连续问题

思路：使用开窗函数去构造一列，然后通过时间列去减这个排序的构造列。如果时间是连续的话，减去的差值是一样的，这样就把连续的时间划分在一个分组里面。

关键词：DATE_SUB     INTERVAL xx day

## 连续问题进阶版

思路二：也是可以通过开窗函数去做，开窗取出分组内的上一条数据，然后做一个 datediff 的操作，在通过 sum if 的开窗函数去累加。如果连续的一直加 0  ，不连续的就加 1 从而区分开

关键词：lag    sum(if( DATEDIFF(login_time ,last_day) <= 2 ,0 ,1))

## 进阶版的解法

可以用于中间间断的连续问题。类似这种需求：

求每个用户最大的连续登陆天数，断一天还算连续登录（两个日期的差小于或等于 2 ）。

# 第二题

## 同时在线问题

如下为某直播平台主播开播及关播时间，根据该数据计算出平台最高峰同时在线的主播 人数。

```sql
id stt edt
1001 2021-06-14 12:12:12 2021-06-14 18:12:12
1003 2021-06-14 13:12:12 2021-06-14 16:12:12
1004 2021-06-14 13:15:12 2021-06-14 20:12:12
1002 2021-06-14 15:12:12 2021-06-14 16:12:12
1005 2021-06-14 15:18:12 2021-06-14 20:12:12
1001 2021-06-14 20:12:12 2021-06-14 23:12:12
1006 2021-06-14 21:12:12 2021-06-14 23:15:12
1007 2021-06-14 22:12:12 2021-06-14 23:10:12
… 
```

首先：改造数据，进入直播间 标记为  1 。反之为 -1。

第二步：对数据做一个 sum 的开窗  ， partition 这里就不用了，因为是整一个分区。

第三步：在上述的开窗函数中，直接一个 max 就可以选择了。

字节有一道面试题就是求每个直播间的最大在线人数。这时候就需要根据 直播的房间号去做一个 partition 的操作了。

## 问题进阶

每一分钟的在播人数。

这部分的关键其实是 假如有时间断了的。这个时候是需要递归生成一个时间的列的。这部分可以另外一个文章。之前写过的。

做了一个辅助的列之后，用这个去做 left join 的操作。然后新增一列 ，这一列是用开窗函数 lag 取上一条。然后在加一个 case when 。



